<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Decoder Layer 0 Viewer</title>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #f7f9fc;
      color: #222;
      margin: 0;
      padding: 20px;
    }
    h1, h2 {
      text-align: center;
      margin: 10px 0;
    }

    /* Flow diagram styles */
    .flow-container {
      display: flex;
      justify-content: center;
      align-items: stretch;
      margin: 20px 0 40px 0;
      gap: 15px;
      flex-wrap: wrap;
    }
    .flow-box {
      padding: 12px 18px;
      border-radius: 10px;
      color: #111;
      font-weight: 600;
      font-size: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      text-align: center;
      min-width: 140px;
    }
    .flow-box small {
      display: block;
      margin-top: 6px;
      font-size: 12px;
      font-weight: normal;
      color: #444;
    }
    .input-box { background: #dbeafe; }
    .qkv-box { background: #fde2e2; }
    .heads-box { background: #e0e7ff; }
    .concat-box { background: #cffafe; }
    .wo-box { background: #fbcfe8; }
    .residual-box { background: #dcfce7; }
    .ffn-box { background: #fef9c3; }
    .arrow {
      font-size: 18px;
      font-weight: bold;
      color: #666;
      align-self: center;
    }

    /* Head buttons */
    .heads-overview {
      text-align: center;
      margin: 20px auto;
      padding: 15px;
      border-radius: 10px;
      background: #eef2ff;
      max-width: 800px;
    }
    .head-btn {
      display: inline-block;
      margin: 8px;
      padding: 10px 20px;
      border-radius: 8px;
      background: #6366f1;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }
    .head-btn:hover {
      background: #4f46e5;
    }

    /* Detail sections */
    .head-detail {
      margin: 30px auto;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background: white;
      max-width: 1100px;
    }
    .plot {
      margin: 20px 0;
    }

    /* Accordion for tokens */
    .accordion {
      margin-top: 15px;
      border-top: 1px solid #ddd;
    }
    .accordion-item {
      border-bottom: 1px solid #eee;
    }
    .accordion-header {
      padding: 10px;
      cursor: pointer;
      background: #f3f4f6;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .accordion-header:hover {
      background: #e5e7eb;
    }
    .accordion-header .icon {
      transition: transform 0.2s;
    }
    .accordion-header.active .icon {
      transform: rotate(90deg);
    }
    .accordion-body {
      display: none;
      padding: 10px;
      font-size: 13px;
      background: #fafafa;
    }
    .vector {
      white-space: nowrap;
      overflow-x: auto;
      font-family: monospace;
      background: #f1f5f9;
      padding: 5px;
      border-radius: 4px;
    }
    .expand-btn {
      display: inline-block;
      margin-top: 5px;
      font-size: 12px;
      color: #2563eb;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Decoder Layer 0</h1>
  <h2>Flow + Attention Visualization</h2>

  <!-- Flow Diagram -->
  <div class="flow-container" id="flowDiagram">
    <!-- Filled dynamically with shapes -->
  </div>

  <!-- Heads Overview -->
  <div class="heads-overview">
    <h3>Heads Overview</h3>
    <p>Click a head to inspect details.</p>
    <div id="headButtons"></div>
  </div>

  <div id="headDetails"></div>

  <script>
    async function loadData() {
      const res = await fetch("/decoder/layers/3");
      const wrapper = await res.json();
      const data = wrapper.data || wrapper;

      // --- Extract dimensions
      const T = data.seq_len;
      const h = data.num_heads;
      const d_head = data.head_dim;
      const d_model = h * d_head;
      const d_ff = d_model * 4;

      // --- Build flow diagram with shapes
      const flow = document.getElementById("flowDiagram");
      flow.innerHTML = `
        <div class="flow-box input-box">Input<br><small>[B, T=${T}, d_model=${d_model}]</small></div>
        <div class="arrow">→</div>
        <div class="flow-box qkv-box">QKV Proj<br><small>Q,K,V: [B, h=${h}, T=${T}, d_head=${d_head}]</small></div>
        <div class="arrow">→</div>
        <div class="flow-box heads-box">Heads (${h})<br><small>Weights [B, h=${h}, T=${T}, T=${T}]</small></div>
        <div class="arrow">→</div>
        <div class="flow-box concat-box">Concat<br><small>[B, T=${T}, d_model=${d_model}]</small></div>
        <div class="arrow">→</div>
        <div class="flow-box wo-box">W₀<br><small>[B, T=${T}, d_model=${d_model}]</small></div>
        <div class="arrow">→</div>
        <div class="flow-box residual-box">Residual<br><small>[B, T=${T}, d_model=${d_model}]</small></div>
        <div class="arrow">→</div>
        <div class="flow-box ffn-box">FFN<br><small>[B, T=${T}, d_ff=${d_ff}] → [B, T=${T}, d_model=${d_model}]</small></div>
      `;

      // --- Build head buttons
      const buttons = document.getElementById("headButtons");
      data.heads.forEach(head => {
        const btn = document.createElement("div");
        btn.className = "head-btn";
        btn.innerText = "Head " + head.head;
        btn.onclick = () => showHead(head, data.seq_len);
        buttons.appendChild(btn);
      });
    }

    function showHead(head, seqLen) {
      const details = document.getElementById("headDetails");
      details.innerHTML = "";

      const div = document.createElement("div");
      div.className = "head-detail";

      div.innerHTML = `<h3>Head #${head.head}</h3>`;

      // Heatmap
      const matrix = head.tokens.map(t =>
        t.scores_masked.map(v => v === "MASKED" ? NaN : v)
      );
      const yLabels = head.tokens.map(t => "Query t=" + t.token_index);
      const xLabels = Array.from({length: seqLen}, (_, i) => "Key t=" + i);

      const plotDiv = document.createElement("div");
      plotDiv.className = "plot";
      div.appendChild(plotDiv);

      Plotly.newPlot(plotDiv, [{
        z: matrix,
        x: xLabels,
        y: yLabels,
        type: "heatmap",
        colorscale: "Viridis",
        zmin: -1,
        zmax: 1
      }], {
        title: "Attention Matrix",
        xaxis: { title: "Key Tokens", side: "top" },
        yaxis: { title: "Query Tokens", autorange: "reversed" }
      });

      // Accordion for tokens
      const acc = document.createElement("div");
      acc.className = "accordion";
      head.tokens.forEach(tok => {
        const item = document.createElement("div");
        item.className = "accordion-item";

        const header = document.createElement("div");
        header.className = "accordion-header";
        header.innerHTML = `Token ${tok.token_index} <span class="icon">▶</span>`;
        const body = document.createElement("div");
        body.className = "accordion-body";

        header.onclick = () => {
          const isOpen = body.style.display === "block";
          body.style.display = isOpen ? "none" : "block";
          header.classList.toggle("active", !isOpen);
        };

        const addVector = (name, arr) => {
          if (!arr) return;
          const cont = document.createElement("div");
          const preview = arr.slice(0, 8).join(", ") + (arr.length > 8 ? ", ..." : "");
          cont.innerHTML = `<b>${name}:</b> <div class="vector">${preview}</div>`;
          if (arr.length > 8) {
            const exp = document.createElement("div");
            exp.className = "expand-btn";
            exp.innerText = "Expand full vector";
            exp.onclick = () => {
              cont.innerHTML = `<b>${name}:</b> <div class="vector">${arr.join(", ")}</div>`;
            };
            cont.appendChild(exp);
          }
          body.appendChild(cont);
        };

        addVector("Q", tok.q);
        addVector("K", tok.k);
        addVector("V", tok.v);
        addVector("Scores Raw", tok.scores_raw);
        addVector("Scores Masked", tok.scores_masked);
        addVector("Weights Softmax", tok.weights_softmax);
        addVector("Weights Dropout", tok.weights_after_dropout);
        addVector("Context", tok.context);

        item.appendChild(header);
        item.appendChild(body);
        acc.appendChild(item);
      });
      div.appendChild(acc);

      details.appendChild(div);
    }

    loadData();
  </script>
</body>
</html>

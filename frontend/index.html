<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>LLM: Interactive Config & Trainer</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- LeaderLine for connectors -->
<script src="https://cdn.jsdelivr.net/npm/leader-line@1.0.7/leader-line.min.js"></script>

<style>
  /* ---------- PAPER-LIKE THEME (light, soft) ---------- */
  :root{
    --bg:#f6f8fc;
    --ink:#1f2a3a;
    --muted:#6b778c;
    --stroke:#dbe3f3;
    --arrow:#3b82f6;
    --click-badge-size: 24px;
--click-badge-bg: #2746b0;
--click-badge-fg: #ffffff;

    /* block fills */
    --tok:#e2ecff;   --embed:#eaf6e5; --ln:#ffe7c2;  --qkv:#f9c7d1;  --head:#dbe6fb;
    --concat:#e8e6f7; --wo:#f6dff3;   --res:#e7f7e9; --ffn:#fdebd2; --final:#ece4ff;
    --lm:#fde2f0; --loss:#ffe0e0; --optim:#e8f4e8; --panel:#ffffff; --btn:#e9eefc; --btnh:#e2e9fb;
  }

  html,body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial}
  *{box-sizing:border-box}

  header{display:flex;gap:10px;align-items:center;padding:12px 16px;border-bottom:1px solid var(--stroke);background:#fff}
  h1{font-size:18px;margin:0;font-weight:700}
  .pill{margin-left:auto;border:1px solid var(--stroke);border-radius:999px;padding:4px 10px;color:var(--muted);font-size:12px;background:#fff}

  .wrap{display:flex;align-items:stretch}
  .left{flex:1;min-width:0; display:flex; flex-direction:column;}
  .right{width:360px;border-left:1px solid var(--stroke);background:#fff;padding:12px;position:sticky;top:0;max-height:100vh;overflow-y:auto;}

  /* right panel */
  .panelTitle{font-size:14px;margin:0 0 8px 0}
  .hint{color:var(--muted);font-size:12px;margin:0 0 8px 0}
  .kv{display:grid;grid-template-columns: 1fr; gap:8px}
  .kv-group-title { font-weight: 700; margin-top: 10px; margin-bottom: 5px; font-size: 13px; color: #37435a;}
  .rowKV{display:grid;grid-template-columns: 1fr 1fr;align-items:center;gap:8px;border-bottom:1px dashed var(--stroke);padding:6px 0}
  .rowKV label{font-size:12px;color:#3b4a66;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;display:flex;align-items:center;gap:4px;}
  .rowKV input[type="text"], .rowKV input[type="number"]{width:100%;background:#fff;border:1px solid var(--stroke);color:var(--ink);border-radius:8px;padding:6px 8px;}
  .rowKV input[readonly]{opacity:0.7;background:#fafbff}
  .rowKV input[type="checkbox"]{transform:scale(1.1)}
  .okFlash{box-shadow:0 0 0 2px #2d7a46 inset}
  .badFlash{box-shadow:0 0 0 2px #b44 inset}

  .tooltip-icon-wrapper { cursor: help; }
  .tooltip-icon { font-size: 10px; border: 1px solid var(--muted); border-radius: 50%; width: 14px; height: 14px; display: inline-block; text-align: center; line-height: 14px; color: var(--muted); }

  /* Parameter Count Display */
  .param-count-box { background: #fff; border: 1px solid var(--stroke); border-radius: 10px; padding: 12px; margin-bottom: 16px; text-align: center; }
  .param-count-box .count { font-size: 20px; font-weight: 800; color: #2746b0; }
  .param-count-box .label, .param-count-box .formula { font-size: 12px; color: var(--muted); }
  .param-count-box .formula { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; line-height: 1.4; margin-top:6px }

  /* Central Training Section */
  .training-section { padding: 16px; border-bottom: 1px solid var(--stroke); text-align: center; background: #fff; }
  .training-controls { display: flex; justify-content: center; align-items: center; gap: 16px; }
  .training-controls label { font-size: 14px; }
  .training-controls input { width: 80px; }
  .training-controls button { padding: 10px 20px; font-size: 14px; background: var(--btn); border: 1px solid var(--stroke); border-radius: 8px; color: #1c2b5a; cursor: pointer; }
  .training-controls button:hover { background: var(--btnh); }
  .progress-container { width: 300px; background-color: #e6ebf9; border-radius: 8px; overflow: hidden; height: 20px; margin: 10px auto 0 auto; border:1px solid var(--stroke) }
  .progress-bar { width: 0%; height: 100%; background-color: #4CAF50; transition: width 0.3s ease-in-out; }
  .training-status { text-align: center; margin-top: 4px; font-size: 12px; color: var(--muted); min-height: 16px; }
  .err{color:#c0392b;margin:8px 12px;text-align:center;font-size:13px;min-height:18px;}

  /* --- hero intro strip --- */
.hero {
  max-width:1180px; margin:10px auto 0; background:#fff;
  border:1px solid var(--stroke); border-radius:12px; padding:14px 16px;
  display:grid; grid-template-columns:1.3fr .7fr; gap:16px; align-items:center;
  box-shadow:0 2px 8px rgba(14,30,84,.05);
}
.hero h2{ margin:0; font-size:18px; font-weight:800; letter-spacing:.1px }
.hero p.sub{ margin:6px 0 0; color:var(--muted); font-size:13px }
.hero-list{ margin:10px 0 0; padding-left:18px; color:#3b4a66; font-size:13px }
.hero-list li{ margin:2px 0 }
.badges{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px }
.badge{ background:#f1f5ff; border:1px solid var(--stroke); border-radius:999px; padding:4px 8px; font-size:12px; color:#2746b0 }
.quick-links{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end }
.quick-links a{
  background:var(--btn); border:1px solid var(--stroke); border-radius:10px;
  padding:8px 10px; text-decoration:none; color:#1c2b5a; font-size:13px;
}
.quick-links a:hover{ background:var(--btnh) }
.legend{ display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-top:10px }
.legend .chip{ display:flex; align-items:center; gap:6px; font-size:12px; color:#3b4a66 }
.legend .sw{ width:12px; height:12px; border-radius:3px; border:1px solid var(--stroke) }

  /* ---------------- Diagram (paper look) ---------------- */
  #canvas{ padding:12px }
  .graph{
    max-width:1180px;       /* narrower, centered column */
    margin-inline:auto;
    padding-inline:6px;     /* tiny inner side padding */
  }

  .decoder{
    border:1px solid var(--stroke);
    border-radius:14px;
    padding:12px 14px;
    margin:16px 0;
    background: var(--panel);
    box-shadow:0 2px 8px rgba(14,30,84,.05);
  }
  .decoder h3{ margin:0 0 8px 4px; font-size:12px; color:#5c6b86; font-weight:800; letter-spacing:.2px }

  .row{ display:flex; align-items:center; gap:10px; flex-wrap:wrap }
  .gap{ height:10px }

  .blk{
    min-width:118px; height:48px; border-radius:12px;
    display:flex; flex-direction:column; justify-content:center; gap:2px;
    padding:6px 10px; border:1px solid var(--stroke); color:var(--ink);
  }
  .blk .t{ font-size:13px; font-weight:800 }
  .blk .s{ font-size:11px; color:#4b5878 }

  .wide{ min-width:230px }
  .heads{ min-width:260px; height:70px; position:relative; padding:6px 10px 8px 10px; }

  .tok   { background:var(--tok) }
  .emb   { background:var(--embed) }
  .ln    { background:var(--ln) }
  .qkv   { background:var(--qkv) }
  .heads { background:var(--head) }
  .concat{ background:var(--concat) }
  .wo    { background:var(--wo) }
  .res   { background:var(--res) }
  .ffn   { background:var(--ffn) }
  .final { background:var(--final) }
  .lm    { background:var(--lm) }
  .loss  { background:var(--loss) }
  .optim { background:var(--optim) }

  /* mini head cells */
  .heads-grid{
    position:absolute; left:10px; right:10px; bottom:8px; top:26px;
    display:grid; grid-auto-rows:1fr; gap:6px;
  }
  .hcell{
    border:1px solid rgba(30,60,120,0.18);
    border-radius:8px;
    background:rgba(255,255,255,0.55);
    display:flex; align-items:center; justify-content:center;
    font-size:11px; color:#2d3f7a;
    font-weight:600;
  }

/* clickable affordance */
.clickable{ cursor:pointer; position:relative }
.clickable:hover{ filter:brightness(.98) }

/* BIG circular arrow badge (visible) */
.blk.clickable::after,
.decoder.clickable::after{
  content: "➔";                       /* big arrow glyph */
  position: absolute;
  top: 6px; right: 8px;               /* corner position */
  width: var(--click-badge-size);
  height: var(--click-badge-size);
  border-radius: 999px;
  background: var(--click-badge-bg);
  color: var(--click-badge-fg);
  font-size: 14px;                    /* arrow size inside badge */
  font-weight: 900;
  line-height: 1;                     /* center nicely */
  display: flex; align-items: center; justify-content: center;
  box-shadow: 0 2px 6px rgba(0,0,0,.18);
  opacity: 0.95;
  transform: translateY(0);
  transition: transform .15s ease, filter .15s ease, opacity .15s ease;
  pointer-events: none;               /* don't block clicks */
}

/* slightly larger badge for big decoder sections */
.decoder.clickable::after{
  top: 10px; right: 12px;
  width: calc(var(--click-badge-size) + 6px);
  height: calc(var(--click-badge-size) + 6px);
  font-size: 16px;
  opacity: 0.9;
}

.clickable:hover::after{
  transform: translateY(-1px) scale(1.06);
  filter: brightness(1.08);
  opacity: 1;
}

</style>
<div id="view-counter"></div>

<style>
#view-counter {
  position: fixed;
  top: 60px;   /* adjust this value until it sits nicely below the pill */
  right: 12px;
  background: rgba(255,255,255,0.95);
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  padding: 6px 10px;
  font-size: 12px;
  color: #475569;
  box-shadow: 0 1px 3px rgba(0,0,0,0.15);
  z-index: 9999;
}



</style>

</head>
<body>
<header>
  <h1>LLM Architecture Explorer</h1>
  <span id="meta" class="pill">loading…</span>
</header>


<!-- HERO INTRO START -->
<div class="hero" id="heroIntro">
  <div>
    <h2>LLM Trainer & Explorer — Interactive Overview</h2>
    <p class="sub">Click any box to open Tokenization, Embeddings, Decoder/Attention, FFN, Loss/Gradients, or Optimization.</p>
    <ul class="hero-list">
      <li>Configure your LLM parameters on the right to see live changes (L, H, D, D<sub>FF</sub>, |V|).</li>
      <li>Hover the <b>?</b> icons for concise explanations.</li>
      <li>Use the training controls below to simulate steps and watch progress.</li>
    </ul>
    <div class="badges" id="heroBadges"></div>
    <div class="legend">
      <div class="chip"><span class="sw" style="background:var(--qkv)"></span>QKV Proj</div>
      <div class="chip"><span class="sw" style="background:var(--head)"></span>Heads</div>
      <div class="chip"><span class="sw" style="background:var(--wo)"></span>W_O</div>
      <div class="chip"><span class="sw" style="background:var(--ffn)"></span>FFN / MLP</div>
      <div class="chip"><span class="sw" style="background:var(--lm)"></span>Output Head</div>
      <div class="chip"><span class="sw" style="background:var(--loss)"></span>Loss / Gradients</div>
    </div>
  </div>

  </div>
</div>
<!-- HERO INTRO END -->



<div class="training-section">
  <div class="training-controls">
    <label for="stepsInput">Training Steps:</label>
    <input type="number" id="stepsInput" value="100" min="1"
       class="tinput" />
    <button id="startTrainingBtn">🚀 Start LLM Model Training</button>
  </div>
  <div id="training-progress-container" style="display:none;">
    <div class="progress-container">
      <div id="training-progress-bar" class="progress-bar"></div>
    </div>
    <div id="training-status"></div>
  </div>
  <div id="err" class="err"></div>
</div>

<div class="wrap">
  <div class="left">
    <div id="canvas"></div>
  </div>

  <aside class="right">
    <div id="explanation-panel" style="background:#fff;border:1px solid var(--stroke);border-radius:10px;padding:12px;margin-bottom:12px;">
      <h4 style="margin:0 0 6px 0;color:#4b5878;font-size:14px">Parameter Explanation</h4>
      <p style="margin:0;font-size:13px;line-height:1.6;">Hover over a ❔ icon in the config panel for details.</p>
    </div>

    <div class="param-count-box">
      <div id="param-count" class="count">--</div>
      <div class="label">Trainable Parameters</div>
      <div id="param-formula" class="formula"></div>
    </div>
    <!-- Link to Memory Calculator Page -->
<div style="margin-bottom: 16px; text-align: center;">
  <a href="LLMMemory.html" target="_blank" 
     style="display:inline-block; padding:10px 14px; background:var(--btn); border:1px solid var(--stroke);
            border-radius:8px; text-decoration:none; color:#1c2b5a; font-size:14px; font-weight:600;">
    📊 Open LLM Memory Calculator
  </a>
  <p style="font-size:12px; color:var(--muted); margin-top:6px;">
    Estimate GPU memory for parameters & activations
  </p>
</div>

    <h2 class="panelTitle">Model Configuration,Decide Number of Trainable Paramater</h2>
    <p class="hint">Editable: numbers & booleans. Strings are read-only.</p>
    <div id="cfgForm" class="kv"></div>
    <div style="margin-top: 12px; text-align: center;">
      <button id="saveAllBtn" style="width: 100%; padding: 10px; background: var(--btn); border: 1px solid var(--stroke); border-radius: 8px; color: #1c2b5a; cursor: pointer;">Save All Changes</button>
    </div>
  </aside>
</div>

<script>
/* -------------------- endpoints & routes -------------------- */
const CONFIG_ENDPOINT = "/config";
const CONFIG_SAVE_ENDPOINT = "/config";
const START_TRAINING_ENDPOINT = "/start_training";
const ROUTES = {
  tokenization: 'tokenization.html',
  embeddings: 'embeddings.html',
  decoderPattern: 'decoder_layer_{i}.html',
  ffnPattern: 'decoder_layer_{i}_FFN.html',
  output: 'output.html',
  loss: 'loss.html',
  optim: 'optim.html'
};

/* ---------- helpers ---------- */
function cleanJSON(t){ t = (t||'').replace(/^\uFEFF/, '').trim(); t = t.replace(/^\)\]\}',?\s*/, ''); t = t.replace(/^\s*\/\/.*$/gm,'').replace(/\/\*[\s\S]*?\*\//g,''); t = t.replace(/,\s*([}\]])/g,'$1'); return t; }
function unwrapConfigPayload(raw){ if (!raw || typeof raw !== 'object') return raw; if (raw.data && typeof raw.data === 'object') return raw.data; if (raw.config && typeof raw.config === 'object') return raw.config; return raw; }
function fmt(n){ return new Intl.NumberFormat().format(n); }
function deepFindFirstKey(obj, names){ const targets = names.map(n=>n.toLowerCase()); const stack=[obj]; const paths=[[]]; while(stack.length){ const o = stack.pop(), p = paths.pop(); if(o && typeof o==='object'){ for(const k in o){ const v = o[k], kl=k.toLowerCase(); if(targets.includes(kl)) return {value:v, path:[...p,k].join('.')}; if(v && typeof v==='object'){ stack.push(v); paths.push([...p,k]); } } } } return null; }
const toNum = v => (v===0||v==="0")?0 : (v==null||v==="")?NaN : (n=Number(String(v).trim?.() ?? v), Number.isFinite(n)?n:NaN);
const deepNum = (cfg, keys, fb)=>{ const h=deepFindFirstKey(cfg,keys); if(!h) return {v:fb}; const n=toNum(h.value); return Number.isFinite(n)?{v:n}:{v:fb}; };
const deepBool=(cfg,keys,fb=false)=>{const h=deepFindFirstKey(cfg,keys); if(!h) return {v:fb}; const x=h.value; return {v:(typeof x==='string')?/^(true|1|yes)$/i.test(x.trim()):!!x};};
const deepStr=(cfg,keys,fb='')=>{ const h=deepFindFirstKey(cfg,keys); return {v:h?String(h.value):fb}; };

function normalize(cfg){
  const L   = Math.max(1, Math.floor(deepNum(cfg,['num_layers','n_layers','layers','num_decoder_layers'],4).v));
  const H   = Math.max(1, Math.floor(deepNum(cfg,['num_heads','n_heads','heads','num_attention_heads'],8).v));
  const DM  = Math.max(1, Math.floor(deepNum(cfg,['hidden_size','d_model','model_dim'],256).v));
  const DFF = Math.max(1, Math.floor(deepNum(cfg,['intermediate_size','ffn_hidden_size','mlp_dim','d_ff'], Math.max(4*DM,DM)).v));
  const VOC = Math.max(1, Math.floor(deepNum(cfg,['vocab_size','vocabulary_size','vocab','n_vocab'],50257).v));
  const rope= !!deepBool(cfg,['use_rotary','rope','rotary_pos_emb'],false).v;
  const ropeDim = (n=>Number.isFinite(n)?Math.floor(n):null)(deepNum(cfg,['rotary_dim','rope_dim'],NaN).v);
  const dHead = Math.max(1, Math.floor(DM / Math.max(1,H)));
  return {L,H,DM,DFF,VOC,rope,ropeDim,dHead};
}

/* ---------- LeaderLine helpers ---------- */
let _lines = [];
function clearLines(){ while(_lines.length){ try{ _lines.pop().remove(); }catch(e){} } }
function lineColor(){ return getComputedStyle(document.documentElement).getPropertyValue('--arrow').trim(); }
function connectH(a,b){
  const l = new LeaderLine(a,b,{path:'straight',startSocket:'right',endSocket:'left',startPlug:'behind',endPlug:'arrow3',color:lineColor(),size:2});
  _lines.push(l); return l;
}
function connectL(a,b,ss,es){
  const l = new LeaderLine(a,b,{path:'grid',startSocket:ss,endSocket:es,startPlug:'behind',endPlug:'arrow3',color:lineColor(),size:2});
  _lines.push(l); return l;
}

/* ---------- DOM helpers ---------- */
function mk(tag,cls,id){ const el=document.createElement(tag); if(cls) el.className=cls; if(id) el.id=id; return el; }
function blk(parent,id,cls,t,s){
  const b=mk('div',`blk ${cls}`,id);
  const tt=mk('div','t'); tt.innerHTML=t; b.appendChild(tt);
  if(s){ const ss=mk('div','s'); ss.innerHTML=s; b.appendChild(ss); }
  parent.appendChild(b); return b;
}
function addHeadsGrid(container, H){
  const cols = Math.min(10, H);
  const grid = mk('div','heads-grid');
  grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
  for(let i=0;i<H;i++){
    const c = mk('div','hcell');
    c.textContent = i;
    grid.appendChild(c);
  }
  container.appendChild(grid);
}
function updateHeroBadges(cfg){
  const {L,H,DM,DFF,VOC} = normalize(cfg);
  const hero = document.getElementById('heroBadges');
  if(!hero) return;
  hero.innerHTML = `
    <span class="badge">Layers: ${L}</span>
    <span class="badge">Heads: ${H}</span>
    <span class="badge">Hidden D: ${DM}</span>
    <span class="badge">FFN D: ${DFF}</span>
    <span class="badge">Vocab: ${fmt(VOC)}</span>
  `;
}

/* ---------- RENDERER ---------- */
function renderDiagram(cfg){
  const {L,H,DM,DFF,VOC,dHead} = normalize(cfg);
  document.getElementById('meta').textContent = `L=${L} • H=${H} • D=${DM} • D_FF=${DFF} • |V|=${fmt(VOC)}`;

  clearLines();
  const mount = document.getElementById('canvas');
  mount.innerHTML = '';
  const graph = mk('div','graph'); mount.appendChild(graph);

  /* Tokenization & Embeddings */
  const tokRow = mk('section','decoder'); graph.appendChild(tokRow);
  const tokRowTop = mk('div','row'); tokRow.appendChild(tokRowTop);
  const tok = blk(tokRowTop,'tok','tok','Tokenization','text → ids / mask');
  tok.classList.add('clickable'); tok.setAttribute('role','link'); tok.setAttribute('aria-label','Open tokenization');
  tok.addEventListener('click', ()=>window.location.assign(ROUTES.tokenization));

  const embRowTop = mk('div','row'); tokRow.appendChild(embRowTop);
  const emb = blk(embRowTop,'emb','emb','Embeddings',`token &amp; positional, |V|=${fmt(VOC)}`);
  emb.classList.add('clickable'); emb.setAttribute('role','link'); emb.setAttribute('aria-label','Open embeddings');
  emb.addEventListener('click', ()=>window.location.assign(ROUTES.embeddings));

  connectL(tok, emb, 'bottom', 'top');

  /* Decoders */
  const decRows = [];
  for(let i=0;i<L;i++){
    const dec = mk('section','decoder',`dec${i}`);
    dec.classList.add('clickable'); dec.setAttribute('role','link'); dec.setAttribute('aria-label',`Open decoder layer ${i}`);
    const title = mk('h3'); title.textContent=`Decoder ${i}`; dec.appendChild(title);

    const r1 = mk('div','row'); dec.appendChild(r1);
    const lnTop = blk(r1,`dec${i}-ln-top`,'ln','LayerNorm');
    const qkv   = blk(r1,`dec${i}-qkv`,'qkv','QKV Proj',`H=${H}, d<sub>h</sub>=${Math.max(1,Math.floor(DM/Math.max(1,H)))}`);
    const heads = blk(r1,`dec${i}-heads`,'heads','Heads ('+H+')',`d<sub>h</sub>=${Math.max(1,Math.floor(DM/Math.max(1,H)))}`);
    addHeadsGrid(heads, H);
    const concat= blk(r1,`dec${i}-concat`,'concat','Concat','H × d<sub>h</sub>');
    const wo    = blk(r1,`dec${i}-wo`,'wo','W_O','→ d_model');
    const resTop= blk(r1,`dec${i}-res-top`,'res','Residual','x + AttnOut');

    dec.appendChild(mk('div','gap'));
    const r2 = mk('div','row'); dec.appendChild(r2);
    const lnBot = blk(r2,`dec${i}-ln-bot`,'ln','LayerNorm');
    const ffn   = blk(r2,`dec${i}-ffn`,'ffn wide','FFN / MLP',`d<sub>ff</sub>=${DFF}`);
    const resBot= blk(r2,`dec${i}-res-bot`,'res','Residual','x′ + MLP');

    // clicks (pointer shown via .clickable)
    dec.addEventListener('click', ()=>window.location.assign(ROUTES.decoderPattern.replace('{i}',String(i))));
    ffn.classList.add('clickable');
    ffn.addEventListener('click', (e)=>{ e.stopPropagation(); window.location.assign(ROUTES.ffnPattern.replace('{i}',String(i))); });

    graph.appendChild(dec);
    decRows.push({lnTop,qkv,heads,concat,wo,resTop,lnBot,ffn,resBot});
  }

  /* Final row */
  const final = mk('section','decoder','final-row'); graph.appendChild(final);
  const rf = mk('div','row'); final.appendChild(rf);
  const finalLn = blk(rf,'final-ln','final','Final LayerNorm');
  const lm      = blk(rf,'lm','lm wide','Output Head (LM)','proj→|V|');
  const loss    = blk(rf,'loss','loss','Loss','NLL / CE / smoothing');
  const optim   = blk(rf,'optim','optim','Optimization','AdamW / AMP');

  lm.classList.add('clickable'); loss.classList.add('clickable'); optim.classList.add('clickable');
  lm.addEventListener('click',   ()=>window.location.assign(ROUTES.output));
  loss.addEventListener('click', ()=>window.location.assign(ROUTES.loss));
  optim.addEventListener('click',()=>window.location.assign(ROUTES.optim));

  /* Wiring */
  if(decRows.length) connectL(emb, decRows[0].lnTop, 'bottom', 'left');

  decRows.forEach(r=>{
    connectH(r.lnTop, r.qkv);
    connectH(r.qkv,   r.heads);
    connectH(r.heads, r.concat);
    connectH(r.concat,r.wo);
    connectH(r.wo,    r.resTop);

    connectH(r.lnBot, r.ffn);
    connectH(r.ffn,   r.resBot);

    connectL(r.resTop, r.lnBot, 'bottom', 'left');  // Residual(top) → LN(bottom)
  });

  for(let i=0;i<decRows.length-1;i++){
    connectL(decRows[i].resBot, decRows[i+1].lnTop, 'right', 'left');
  }

  if(decRows.length){
    connectL(decRows[decRows.length-1].resBot, finalLn, 'bottom', 'left');
  }

  connectH(finalLn, lm);
  connectH(lm, loss);
  connectH(loss, optim);

  const positionAll = ()=>_lines.forEach(l=>{ try{ l.position(); }catch(e){} });
  setTimeout(positionAll, 60);
  ['resize','scroll'].forEach(evt=>window.addEventListener(evt, positionAll, {passive:true}));
}

/* ---------- config + training logic (unchanged) ---------- */
let CURRENT_CFG = null;
const paramExplanations = {
  hidden_size: "The main dimension of the model. Larger values increase capacity but also memory and computation. Must be divisible by the number of heads.",
  num_heads: "Controls how many different patterns the attention mechanism can focus on at once.",
  num_layers: "Stacked decoder blocks.",
  intermediate_size: "FFN hidden size (often 4× hidden_size).",
  max_position_embeddings: "Maximum sequence length.",
  use_rotary: "Enable Rotary Positional Embeddings (RoPE).",
  rotary_dim: "Must be even and ≤ head dimension.",
  lr: "Learning rate."
};

function buildConfigForm(cfg){
  const form = document.getElementById('cfgForm'); form.innerHTML = '';
  const archKeys = ['hidden_size','num_heads','num_layers','intermediate_size','max_position_embeddings','vocab_size','use_rotary','rotary_dim'];
  const trainingKeys = ['batch_size','lr','schedule'];

  function createGroup(keys, title, editableKeys = []) {
    const relevant = keys.filter(k=>k in cfg); if(!relevant.length) return;
    const h = document.createElement('h3'); h.className='kv-group-title'; h.textContent=title; form.appendChild(h);

    for (const k of relevant.sort()){
      const v = cfg[k];
      const row = document.createElement('div'); row.className='rowKV';
      const lab = document.createElement('label'); lab.setAttribute('for','k_'+k);
      const span = document.createElement('span'); span.textContent = k; lab.appendChild(span);

      if (paramExplanations[k]) {
        const iconWrapper = document.createElement('div'); iconWrapper.className = 'tooltip-icon-wrapper';
        const icon = document.createElement('span'); icon.className = 'tooltip-icon'; icon.textContent = '?';
        iconWrapper.appendChild(icon);
        iconWrapper.addEventListener('mouseover', () => {
          const p = document.getElementById('explanation-panel');
          p.innerHTML = `<h4>${k}</h4><p>${paramExplanations[k]}</p>`;
        });
        lab.appendChild(iconWrapper);
      }
      row.appendChild(lab);

      let editor, kind; const isEditable = editableKeys.includes(k);
      if (typeof v === 'number'){
        editor = document.createElement('input'); editor.type='number'; editor.id='k_'+k;
        editor.value = String(v); editor.step = Number.isInteger(v) ? '1' : 'any'; kind='number';
        editor.readOnly = !isEditable;
      } else if (typeof v === 'boolean'){
        editor = document.createElement('input'); editor.type='checkbox'; editor.id='k_'+k; editor.checked = v; kind='boolean';
        editor.disabled = !isEditable;
      } else {
        editor = document.createElement('input'); editor.type='text'; editor.id='k_'+k; editor.value=String(v); editor.readOnly=true; kind='string';
      }
      editor.dataset.key = k; editor.dataset.kind = kind;
      if (isEditable) editor.addEventListener('input', ()=>{ const { newCfg } = getEditedValues(); calculateAndDisplayParams(newCfg); });
      row.appendChild(editor);
      form.appendChild(row);
    }
  }

  const all = Object.keys(cfg);
  const coreArch = archKeys.filter(k=>all.includes(k));
  const coreTrain= trainingKeys.filter(k=>all.includes(k));
  const other = all.filter(k=>!coreArch.includes(k) && !coreTrain.includes(k));

  createGroup(coreArch, 'Model Architecture', ['hidden_size','num_heads','num_layers','intermediate_size','max_position_embeddings','use_rotary','rotary_dim']);
  createGroup(coreTrain,'Training & Optimization', ['lr']);
  createGroup(other,'Other Parameters', []);
  calculateAndDisplayParams(cfg);

  form.addEventListener('mouseleave', () => {
    const p = document.getElementById('explanation-panel');
    p.innerHTML = `<h4>Parameter Explanation</h4><p>Hover over a ❔ icon for details.</p>`;
  });
}

function calculateAndDisplayParams(cfg){
  const { L, DM, DFF, VOC } = normalize(cfg);
  const embedParams = VOC * DM;
  const layerParams = L * ( (4 * DM * DM) + (DM * DFF * 2) );
  const finalParams = DM * VOC;
  const totalParams = embedParams + layerParams + finalParams;

  const el = document.getElementById('param-count');
  if (totalParams > 1e9) el.textContent = (totalParams/1e9).toFixed(2)+' B';
  else if (totalParams > 1e6) el.textContent = (totalParams/1e6).toFixed(2)+' M';
  else if (totalParams > 1e3) el.textContent = (totalParams/1e3).toFixed(2)+' K';
  else el.textContent = fmt(totalParams);

  document.getElementById('param-formula').innerHTML =
    `(V×D) + L×(4D² + 2D×Dff) + (D×V)<br><span style="font-size:10px;">V:Vocab, D:Hidden, L:Layers, Dff:FFN</span>`;
}

function getEditedValues(){
  const inputs = document.querySelectorAll('#cfgForm input');
  const newCfg = {...CURRENT_CFG};
  let allValid = true;
  let validationMessage = '';

  for(const el of inputs){
    const key = el.dataset.key, kind = el.dataset.kind;
    el.classList.remove('okFlash', 'badFlash');
    if (el.readOnly || el.disabled) continue;

    if (kind === 'number'){
      const num = Number(el.value);
      if (!Number.isFinite(num)){ allValid=false; el.classList.add('badFlash'); continue; }
      const orig = CURRENT_CFG[key];
      newCfg[key] = (typeof orig === 'number' && Number.isInteger(orig)) ? Math.round(num) : num;
    } else if (kind === 'boolean'){
      newCfg[key] = !!el.checked;
    }
  }
  const { DM, H, dHead } = normalize(newCfg);
  if (DM % H !== 0) {
    allValid = false;
    validationMessage = `hidden_size (${DM}) must be divisible by num_heads (${H}).`;
    document.getElementById('k_hidden_size')?.classList.add('badFlash');
    document.getElementById('k_num_heads')?.classList.add('badFlash');
  }
  if (newCfg.rotary_dim && (newCfg.rotary_dim > dHead || newCfg.rotary_dim % 2 !== 0)) {
    allValid = false;
    validationMessage = `rotary_dim (${newCfg.rotary_dim}) must be an even number <= head dimension (${dHead}).`;
    document.getElementById('k_rotary_dim')?.classList.add('badFlash');
  }
  if (newCfg.lr && (newCfg.lr <= 0 || newCfg.lr > 0.01)) {
    allValid = false;
    validationMessage = `Learning rate (${newCfg.lr}) is outside the typical range of (0, 0.01].`;
    document.getElementById('k_lr')?.classList.add('badFlash');
  }

  return { newCfg, allValid, validationMessage };
}

async function updateAll(){
  const { newCfg, allValid, validationMessage } = getEditedValues();
  const err = document.getElementById('err'); err.textContent='';

  if (!allValid){ err.textContent = validationMessage || 'Please fix invalid values before saving.'; return; }
  try{
    const url = new URL(CONFIG_SAVE_ENDPOINT, window.location.href);
    const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(newCfg) });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    CURRENT_CFG = newCfg;
    renderDiagram(CURRENT_CFG);
    buildConfigForm(CURRENT_CFG);
    err.textContent = '✅ Config saved successfully!'; err.style.color = '#2e7d32';
    setTimeout(()=>{ err.textContent=''; err.style.color=''; }, 2000);
  }catch(_e){
    err.textContent = 'Failed to save config. Please check server.'; err.style.color = '#c0392b';
  }
}

async function startTraining(){
  const startBtn = document.getElementById('startTrainingBtn');
  const stepsInput = document.getElementById('stepsInput');
  const err = document.getElementById('err');
  const progressContainer = document.getElementById('training-progress-container');
  const progressBar = document.getElementById('training-progress-bar');
  const statusMessage = document.getElementById('training-status');

  err.textContent=''; statusMessage.textContent='';
  const totalSteps = parseInt(stepsInput.value,10);
  if (isNaN(totalSteps) || totalSteps < 1){ err.textContent='Please enter a valid number of steps.'; return; }

  startBtn.style.display='none';
  progressContainer.style.display='block';
  progressBar.style.width='0%';

  try{
    for (let currentStep=1; currentStep<=totalSteps; currentStep++){
      const progress = (currentStep/totalSteps)*100;
      progressBar.style.width = `${progress}%`;
      statusMessage.textContent = `Training step ${currentStep} of ${totalSteps}...`;
      await new Promise(r=>setTimeout(r,30));
    }
    const res = await fetch(START_TRAINING_ENDPOINT, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ steps: totalSteps }) });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    statusMessage.textContent = 'Training completed successfully!'; err.textContent = '';
  }catch(e){
    err.textContent = 'Failed to start training. Check server.'; statusMessage.textContent = 'Training failed.';
  }finally{
    setTimeout(()=>{ progressContainer.style.display='none'; startBtn.style.display='inline-block'; }, 2000);
  }
}

const DEFAULT_CFG = { "model_name": "default-model", "hidden_size": 256, "num_heads": 8, "num_layers": 4, "intermediate_size": 1024, "max_position_embeddings": 128, "vocab_size": 50257, "use_rotary": true, "rotary_dim": 32, "lr": 3e-4 };

async function loadConfig(){
  const err = document.getElementById('err'); err.textContent='';
  try{
    const url = new URL(CONFIG_ENDPOINT, window.location.href);
    url.searchParams.append('ts', Date.now());
    const res = await fetch(url.toString(), { cache:'no-store', headers:{'Accept':'application/json'} });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const text = await res.text();
    const raw = JSON.parse(cleanJSON(text));
    CURRENT_CFG = unwrapConfigPayload(raw);
    renderDiagram(CURRENT_CFG);
    buildConfigForm(CURRENT_CFG);
  }catch(e){
    err.textContent='Failed to load config. Using default values.';
    CURRENT_CFG = DEFAULT_CFG;
    renderDiagram(CURRENT_CFG);
    buildConfigForm(CURRENT_CFG);
  }
}

window.addEventListener('resize', ()=>CURRENT_CFG && renderDiagram(CURRENT_CFG));
document.addEventListener('DOMContentLoaded', () => {
  loadConfig();
  document.getElementById('saveAllBtn').addEventListener('click', updateAll);
  document.getElementById('startTrainingBtn').addEventListener('click', startTraining);
});
</script>
<script>
async function loadViews(){
  try {
    const res = await fetch("/views");
    const data = await res.json();
    document.getElementById("view-counter").textContent =
      `👀 Total Views: ${data.total_views}`;
  } catch(e){
    console.error(e);
    document.getElementById("view-counter").textContent = "👀 Views: error";
  }
}
loadViews();
</script>
<!-- Drop-in snippet: three tiny tabs fixed at the top-right linking to your three pages. -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Top‑Right Mini Tabs</title>
<style>
  /* ===== Mini Tabs Component ===== */
  .tt-mini-tabs{position:fixed;top:60px;right:10px;z-index:10000;display:flex;gap:6px;align-items:center;background:rgba(255,255,255,.92);border:1px solid #e2e8f0;border-radius:12px;padding:6px 6px;box-shadow:0 2px 10px rgba(0,0,0,.08);backdrop-filter:blur(6px)}
  .tt-mini-tabs a{--fg:#1f2a3a;--muted:#64748b;display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:9px;text-decoration:none;color:var(--fg);border:1px solid transparent;font:600 12px/1 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .tt-mini-tabs a .sub{font-weight:600;opacity:.7}
  .tt-mini-tabs a:hover{background:#eef2ff;border-color:#c7d2fe}
  .tt-mini-tabs a.active{background:#dbeafe;border-color:#93c5fd}
  .tt-mini-tabs a:focus{outline:2px solid #93c5fd;outline-offset:2px}
  @media (max-width:600px){.tt-mini-tabs{top:8px;right:8px;padding:4px}.tt-mini-tabs a{padding:5px 8px;font-size:11px}}
</style>
</head>
<body>

<!-- Replace the hrefs below with your actual page URLs -->
<nav class="tt-mini-tabs" role="navigation" aria-label="Tiny Transformer pages">
  <a href="LLMMathLearnings.html"  title="Forward pass (all matrices)"        data-key="forward"><span>Forward</span></a>
  <a href="LLMMathLearningsgraidient.html"     title="Loss & Backprop (continuation)"      data-key="loss"><span>Loss</span></a>
  <a href="LLMMathLearningsAdamOptimizer.html"     title="Adam Optimizer (all parameters)"     data-key="adam"><span>Adam</span></a>
</nav>

<script>
  // Auto-highlight current tab if the href matches the page URL
  (function(){
    var tabs=document.querySelectorAll('.tt-mini-tabs a');
    var here=location.pathname.toLowerCase();
    tabs.forEach(function(a){
      var href=a.getAttribute('href');
      if(!href) return; var norm=href.toLowerCase();
      if(here.endsWith(norm) || here.includes('/'+norm)){
        a.classList.add('active'); a.setAttribute('aria-current','page');
      }
    });
  })();
</script>

</body>
</html>

</body>
</html>

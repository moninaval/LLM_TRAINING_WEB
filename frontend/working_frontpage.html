<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>LLM: Input → Decoder → Output Head</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#0b1020; --fg:#e6eaf2; --muted:#9aa4b2; --stroke:#27314a; --arrow:#86a2ff;
    --input:#2a3b67; --ln:#32406f; --qkv:#215b72; --head:#1e6b74; --concat:#3b2f63; --wo:#4a2a3a;
    --res:#644b1f; --ffn:#205c38; --final:#3b2d52; --lm:#5a3350;
  }
  html,body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto}
  header{display:flex;gap:10px;align-items:center;padding:10px 12px;border-bottom:1px solid var(--stroke)}
  h1{font-size:16px;margin:0}
  .pill{margin-left:auto;border:1px solid var(--stroke);border-radius:999px;padding:4px 10px;color:var(--muted);font-size:12px}
  .row{display:flex;gap:10px;align-items:center;padding:10px 12px}
  button{background:#1f2a48;color:var(--fg);border:1px solid var(--stroke);border-radius:10px;padding:8px 10px;cursor:pointer}
  button:hover{background:#233055}
  svg{width:100%;height:auto;display:block;border-top:1px solid var(--stroke)}
  .box{fill:#1a2545;stroke:var(--stroke);stroke-width:1}
  .b-input{fill:var(--input)} .b-ln{fill:var(--ln)} .b-qkv{fill:var(--qkv)} .b-head{fill:var(--head)}
  .b-concat{fill:var(--concat)} .b-wo{fill:var(--wo)} .b-res{fill:var(--res)} .b-ffn{fill:var(--ffn)}
  .b-final{fill:var(--final)} .b-lm{fill:var(--lm)}
  .label{fill:#e6ecff;font-size:12px;font-weight:600}
  .sublabel{fill:#bcd;font-size:11px}
  .layerTitle{fill:#a7b8d8;font-size:12px}
  .arrow{stroke:var(--arrow);stroke-width:1.6;marker-end:url(#ah)}
  .gridnum{fill:#dff;font-size:10px;text-anchor:middle;dominant-baseline:middle}
  .err{color:#ff9b9b;margin:8px 12px}
</style>
</head>
<body>
<header>
  <h1>Input → Decoder → Output Head</h1>
  <span id="meta" class="pill">loading…</span>
</header>

<div class="row">
  <button id="reload">Reload Config</button>
  <span id="parsed" class="pill">—</span>
</div>

<div id="err" class="err"></div>
<div id="canvas"></div>

<script>
// ---- CONFIG ----
const CONFIG_ENDPOINT = "/config"; // change to "/config" if that's your route

// ---- FAST JSONC SANITIZER ----
function cleanJSON(text){
  let t = text.replace(/^\uFEFF/, '').trim();
  t = t.replace(/^\)\]\}',?\s*/, '');                // JSON safety prefix
  t = t.replace(/^\s*\/\/.*$/gm,'');                 // // comments
  t = t.replace(/\/\*[\s\S]*?\*\//g,'');             // /* */ comments
  t = t.replace(/,\s*([}\]])/g,'$1');                // trailing commas
  return t;
}

// ---- DEEP KEY LOOKUP (fast DFS, case-insensitive) ----
function deepFindFirstKey(obj, names){
  const targets = names.map(n=>n.toLowerCase());
  const stack = [obj];
  const pathStack = [[]];
  while (stack.length){
    const o = stack.pop(), path = pathStack.pop();
    if (o && typeof o === 'object'){
      for (const k in o){
        const v = o[k];
        const kLow = k.toLowerCase();
        if (targets.includes(kLow)) return { value:v, path:[...path,k].join('.') };
        if (v && typeof v === 'object'){ stack.push(v); pathStack.push([...path,k]); }
      }
    }
  }
  return null;
}
function toNum(v){
  if (v === 0 || v === "0") return 0;
  if (v == null || v === "") return NaN;
  const n = Number(String(v).trim());
  return Number.isFinite(n) ? n : NaN;
}
function deepNum(cfg, keys, fallback){
  const hit = deepFindFirstKey(cfg, keys);
  if (!hit) return {v:fallback, from:'(default)'};
  const n = toNum(hit.value);
  return Number.isFinite(n) ? {v:n, from:hit.path} : {v:fallback, from:'(default)'};
}
function deepBool(cfg, keys, fallback=false){
  const hit = deepFindFirstKey(cfg, keys);
  if (!hit) return {v:fallback, from:'(default)'};
  const x = hit.value;
  const b = (typeof x === 'string') ? /^(true|1|yes)$/i.test(x.trim()) : !!x;
  return {v:b, from:hit.path};
}
function deepStr(cfg, keys, fallback=''){
  const hit = deepFindFirstKey(cfg, keys);
  if (!hit) return {v:fallback, from:'(default)'};
  return {v:String(hit.value), from:hit.path};
}

function normalize(cfg){
  const L_   = deepNum(cfg, ['num_layers','n_layers','n_layer','layers','num_decoder_layers','decoder_layers'], 4);
  const H_   = deepNum(cfg, ['num_heads','n_heads','n_head','heads','num_attention_heads'], 8);
  const DM_  = deepNum(cfg, ['hidden_size','d_model','model_dim'], 256);
  const DFF_ = deepNum(cfg, ['intermediate_size','ffn_hidden_size','mlp_dim','d_ff'], Math.max(4*DM_.v, DM_.v));
  const VOC_ = deepNum(cfg, ['vocab_size','vocabulary_size','vocab','n_vocab'], 50257);
  const rope_= deepBool(cfg,['use_rotary','rope','rotary_pos_emb'], false);
  const RDM_ = deepNum(cfg, ['rotary_dim','rope_dim'], NaN);
  const ACT_ = deepStr(cfg, ['ffn_type','activation','mlp_activation'], 'gelu');
  const NAME_= deepStr(cfg, ['model_name','name'], 'model');

  const L=Math.max(1,Math.floor(L_.v)), H=Math.max(1,Math.floor(H_.v));
  const DM=Math.max(1,Math.floor(DM_.v)), DFF=Math.max(1,Math.floor(DFF_.v));
  const VOC=Math.max(1,Math.floor(VOC_.v));
  const rope=!!rope_.v, ropeDim=Number.isFinite(RDM_.v)?Math.floor(RDM_.v):null;
  const ffnType=ACT_.v, name=NAME_.v;
  const dHead = Math.max(1, Math.floor(DM / Math.max(1,H)));

  return {L,H,DM,DFF,VOC,rope,ropeDim,ffnType,name,dHead};
}

function fmt(n){ return new Intl.NumberFormat().format(n); }

// ---- SVG PRIMS ----
function box(svg,x,y,w,h,cls,main,sub){
  const g = document.createElementNS('http://www.w3.org/2000/svg','g');
  const r = document.createElementNS('http://www.w3.org/2000/svg','rect');
  r.setAttribute('x',x); r.setAttribute('y',y); r.setAttribute('width',w); r.setAttribute('height',h);
  r.setAttribute('rx',10); r.setAttribute('ry',10); r.setAttribute('class','box '+cls); g.appendChild(r);
  const t = document.createElementNS('http://www.w3.org/2000/svg','text');
  t.setAttribute('x', x+10); t.setAttribute('y', y+20); t.setAttribute('class','label'); t.textContent = main; g.appendChild(t);
  if (sub){ const s = document.createElementNS('http://www.w3.org/2000/svg','text');
    s.setAttribute('x', x+10); s.setAttribute('y', y+38); s.setAttribute('class','sublabel'); s.textContent = sub; g.appendChild(s);
  }
  svg.appendChild(g); return {x,y,w,h};
}
function arrow(svg,x1,y1,x2,y2){
  const p = document.createElementNS('http://www.w3.org/2000/svg','path');
  p.setAttribute('d', `M ${x1} ${y1} L ${x2} ${y2}`); p.setAttribute('class','arrow'); svg.appendChild(p);
}

// ---- RENDER ----
function render(cfg){
  const {L,H,DM,DFF,VOC,rope,ropeDim,ffnType,name,dHead} = normalize(cfg);
  document.getElementById('meta').textContent =
    `${name} • layers=${L} • heads=${H} • d_model=${DM} • d_ff=${DFF} • vocab=${fmt(VOC)}${rope?` • RoPE(d=${ropeDim??'?'})`:''}`;
  document.getElementById('parsed').textContent = `Parsed: layers=${L}, heads=${H}, d_head=${dHead}`;

  const W = Math.min(1600, Math.max(1100, window.innerWidth));
  const layerH = 180, vgap = 30, headW = 240;
  const totalH = 120 + L*(layerH + vgap);

  const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('width', W); svg.setAttribute('height', totalH);

  // arrowhead
  const defs = document.createElementNS('http://www.w3.org/2000/svg','defs');
  const m = document.createElementNS('http://www.w3.org/2000/svg','marker');
  m.setAttribute('id','ah'); m.setAttribute('viewBox','0 0 10 10');
  m.setAttribute('refX','10'); m.setAttribute('refY','5');
  m.setAttribute('markerWidth','8'); m.setAttribute('markerHeight','6'); m.setAttribute('orient','auto-start-reverse');
  const tri = document.createElementNS('http://www.w3.org/2000/svg','path');
  tri.setAttribute('d','M 0 0 L 10 5 L 0 10 z'); tri.setAttribute('fill','#86a2ff');
  m.appendChild(tri); defs.appendChild(m); svg.appendChild(defs);

  const x0 = 40; let y = 20;

  // Input
  const bIn = box(svg, x0, y, 160, 56, 'b-input', 'Input', 'tokens / embeddings');
  y += 70; arrow(svg, bIn.x + bIn.w, bIn.y + 28, x0 + 10, y + 10);

  for (let i=0; i<L; i++){
    const top = y + i*(layerH + vgap);
    const title = document.createElementNS('http://www.w3.org/2000/svg','text');
    title.setAttribute('x', x0); title.setAttribute('y', top - 6); title.setAttribute('class','layerTitle');
    title.textContent = `Decoder ${i}`; svg.appendChild(title);

    const ln1 = box(svg, x0, top, 120, 46, 'b-ln', 'LayerNorm');
    const qkv = box(svg, x0+140, top, 120, 46, 'b-qkv', 'QKV Proj', `H=${H}, dₕ=${dHead}`);

    // Heads grid (adaptive)
    const hx = x0+280, hy = top, headsH = 76;
    const heads = box(svg, hx, hy, headW, headsH, 'b-head', `Heads (${H})`, `dₕ=${dHead}`);
    const cols = Math.min(H, 12);             // up to 12 per row for density
    const rows = Math.ceil(H / cols);
    const cellW = (headW - 16) / cols, cellH = (headsH - 30) / rows;
    let idx = 0;
    for (let r=0; r<rows; r++){
      for (let c=0; c<cols && idx<H; c++, idx++){
        const cx = hx + 8 + c*cellW, cy = hy + 30 + r*cellH;
        const rr = document.createElementNS('http://www.w3.org/2000/svg','rect');
        rr.setAttribute('x', cx); rr.setAttribute('y', cy);
        rr.setAttribute('width', Math.max(10, cellW-6)); rr.setAttribute('height', Math.max(10, cellH-6));
        rr.setAttribute('rx', 6); rr.setAttribute('ry', 6); rr.setAttribute('class','box b-head'); svg.appendChild(rr);
        const num = document.createElementNS('http://www.w3.org/2000/svg','text');
        num.setAttribute('x', cx + Math.max(10, cellW-6)/2);
        num.setAttribute('y', cy + Math.max(10, cellH-6)/2 + 1);
        num.setAttribute('class','gridnum'); num.textContent = idx; svg.appendChild(num);
      }
    }

    const concat = box(svg, hx + headW + 20, top, 90, 46, 'b-concat', 'Concat', 'H × dₕ');
    const wo     = box(svg, hx + headW + 130, top, 100, 46, 'b-wo', 'W_O', '→ d_model');
    const res1   = box(svg, hx + headW + 250, top, 120, 46, 'b-res', 'Residual', 'x + AttnOut');

    const ln2  = box(svg, x0, top+62, 120, 46, 'b-ln', 'LayerNorm');
    const ffn  = box(svg, x0+140, top+62, 160, 46, 'b-ffn', 'FFN / MLP', `d_ff=${DFF} • ${ffnType}`);
    const res2 = box(svg, x0+320, top+62, 120, 46, 'b-res', 'Residual', 'x′ + MLP');

    arrow(svg, ln1.x + ln1.w, ln1.y + 23, qkv.x, qkv.y + 23);
    arrow(svg, qkv.x + qkv.w, qkv.y + 23, heads.x, heads.y + 23);
    arrow(svg, heads.x + heads.w, heads.y + 23, concat.x, concat.y + 23);
    arrow(svg, concat.x + concat.w, concat.y + 23, wo.x, wo.y + 23);
    arrow(svg, wo.x + wo.w, wo.y + 23, res1.x, res1.y + 23);
    arrow(svg, res1.x + res1.w, res1.y + 23, ln2.x, ln2.y + 23);
    arrow(svg, ln2.x + ln2.w, ln2.y + 23, ffn.x, ffn.y + 23);
    arrow(svg, ffn.x + ffn.w, ffn.y + 23, res2.x, res2.y + 23);
    arrow(svg, res2.x + res2.w, res2.y + 23, x0 + 10, top + layerH + vgap);
  }

  // Final
  const endY = 20 + 70 + L*(layerH + vgap) - vgap;
  const fin = box(svg, x0, endY, 160, 56, 'b-final', 'Final LayerNorm');
  const lm  = box(svg, x0 + 180, endY, 220, 56, 'b-lm', 'Output Head (LM)', `proj→|V|=${fmt(VOC)}`);
  arrow(svg, fin.x + fin.w, fin.y + 28, lm.x, lm.y + 28);

  const mount = document.getElementById('canvas');
  mount.innerHTML = ''; mount.appendChild(svg);
}

// ---- LOAD & BOOT ----
async function loadConfig(){
  const err = document.getElementById('err'); err.textContent = '';
  try{
    const url = CONFIG_ENDPOINT + (CONFIG_ENDPOINT.includes('?')?'':'?ts=') + Date.now();
    const res = await fetch(url, { cache:'no-store', headers:{'Accept':'application/json'} });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const text = await res.text();
    const cfg = JSON.parse(cleanJSON(text));
    render(cfg);
  }catch(e){
    err.textContent = `Failed to load config: ${e.message}`;
  }
}
document.getElementById('reload').addEventListener('click', loadConfig);
loadConfig();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Tokenization Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root {
    --bg-dark: #0b1020;
    --text-light: #e6eaf2;
    --panel-bg: #121935;
    --border-color: #27314a;
    --token-bg: #2a3b67;
    --pill-bg: #1f2a48;
    --pill-border: #2a365b;
    --active-bg: #3b2d52;
    --formula-color: #9aa4b2;
  }
  body {
    background-color: var(--bg-dark);
    color: var(--text-light);
    font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .container {
    width: 100%;
    max-width: 900px;
  }
  .card {
    background-color: var(--panel-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1rem;
  }
  .formula {
    font-style: italic;
    color: var(--formula-color);
    margin-bottom: 1.5rem;
    text-align: center;
    font-size: 0.9rem;
  }
  .section-title {
    font-weight: 600;
    font-size: 1.125rem;
    margin-bottom: 0.75rem;
  }
  .pill {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.25rem 0.6rem;
    background-color: var(--pill-bg);
    border: 1px solid var(--pill-border);
    border-radius: 9999px;
    font-size: 0.8rem;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
  }
  .pill:hover, .pill.active {
    background-color: var(--active-bg);
    box-shadow: 0 0 0 2px #5b4685;
  }
  .tokens-grid, .ids-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    max-height: 250px;
    overflow-y: auto;
    padding-right: 10px; /* For scrollbar */
  }
  .text-input-wrap {
    background-color: #0c1330;
    border: 1px solid #263156;
    border-radius: 8px;
    padding: 1rem;
    line-height: 1.6;
  }
  .text-input-word {
    display: inline-block;
    cursor: pointer;
    border-bottom: 1px solid transparent;
    transition: border-color 0.2s, color 0.2s;
  }
  .text-input-word:hover {
    border-color: #86a2ff;
  }
  .text-input-word.active {
    color: #86a2ff;
    font-weight: 600;
    border-color: #86a2ff;
  }
  .attention-mask-item {
    width: 12px;
    height: 12px;
    border-radius: 4px;
    background-color: #27314a;
    transition: background-color 0.2s;
  }
  .attention-mask-item.active {
    background-color: #4CAF50;
  }
</style>
</head>
<body>

<div class="container">
  <div class="formula">
    <p>Text → tokenizer(x) → Tokens → IDs → pad/truncate→T → Attention Mask</p>
  </div>

  <div id="out">
    <div class="text-center text-muted">Loading...</div>
  </div>
</div>

<script>
// ===== CONFIG =====
const ENDPOINT = "/tokenization";
const USE_CREDENTIALS = false;

// ===== Helpers =====
function pickArray(payload){
  if (Array.isArray(payload)) return payload;
  if (payload && typeof payload === 'object') {
    if (Array.isArray(payload.records)) return payload.records;
    if (Array.isArray(payload.data)) return payload.data;
    if (Array.isArray(payload.samples)) return payload.samples;
    if (Array.isArray(payload.result)) return payload.result;
    if (Array.isArray(payload.items)) return payload.items;
  }
  return null;
}

// Function to handle highlighting
function handleHighlight(groupClass, index, isActive) {
    const group = document.querySelector(groupClass);
    if (!group) return;

    if (groupClass === '.input-text-container') {
        const words = group.querySelectorAll('.text-input-word');
        if (words[index]) {
            words[index].classList.toggle('active', isActive);
        }
    } else {
        const pills = group.querySelectorAll('.pill');
        if (pills[index]) {
            pills[index].classList.toggle('active', isActive);
        }
    }
}

function render(arr){
  const outEl = document.getElementById('out');
  outEl.innerHTML = '';

  if (!Array.isArray(arr) || arr.length === 0){
    outEl.innerHTML = '<div class="text-center text-muted">No items to display.</div>';
    return;
  }

  arr.forEach((item, idx) => {
    const sidx = (item && item.sample_index != null) ? item.sample_index : idx;
    const s = (item && item.sample) ? item.sample : item;

    const input_text = s?.input_text ?? '';
    const tokens = Array.isArray(s?.tokens) ? s.tokens : [];
    const ids = Array.isArray(s?.token_ids) ? s.token_ids : (Array.isArray(s?.ids) ? s.ids : []);
    const mask = Array.isArray(s?.attention_mask) ? s.attention_mask : (Array.isArray(s?.mask) ? s.mask : []);

    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="flex items-center justify-between mb-4 pb-2 border-b border-border-color">
        <h3 class="text-xl font-semibold">Sample Index: ${sidx}</h3>
        <span class="text-sm text-gray-400">Tokens: ${tokens.length}</span>
      </div>
      
      <!-- Input Text -->
      <div class="mb-6">
        <h4 class="section-title">Input Text</h4>
        <div class="text-input-wrap">
          ${input_text.split(/\s+/).map((word, i) => `<span class="text-input-word mr-1" data-index="${i}">${word}</span>`).join('')}
        </div>
      </div>

      <!-- Tokens -->
      <div class="mb-6">
        <h4 class="section-title">Tokens</h4>
        <div class="tokens-grid">
          ${tokens.map((token, i) => `<span class="pill token-pill" data-index="${i}">${token}</span>`).join('')}
        </div>
      </div>

      <!-- Token IDs -->
      <div class="mb-6">
        <h4 class="section-title">Token IDs</h4>
        <div class="ids-grid">
          ${ids.map((id, i) => `<span class="pill id-pill" data-index="${i}">${id}</span>`).join('')}
        </div>
      </div>

      <!-- Attention Mask -->
      <div>
        <h4 class="section-title">Attention Mask</h4>
        <div class="flex flex-wrap gap-1">
          ${mask.map(m => `<span class="attention-mask-item ${m == 1 ? 'active' : ''}"></span>`).join('')}
        </div>
      </div>
    `;

    outEl.appendChild(card);
  });

  // Add event listeners for highlighting
  document.querySelectorAll('.text-input-word').forEach(wordEl => {
    const index = parseInt(wordEl.dataset.index);
    if (!isNaN(index)) {
      const correspondingTokens = document.querySelectorAll(`.token-pill[data-index="${index}"]`);
      const correspondingIds = document.querySelectorAll(`.id-pill[data-index="${index}"]`);

      wordEl.addEventListener('mouseenter', () => {
        wordEl.classList.add('active');
        correspondingTokens.forEach(el => el.classList.add('active'));
        correspondingIds.forEach(el => el.classList.add('active'));
      });
      wordEl.addEventListener('mouseleave', () => {
        wordEl.classList.remove('active');
        correspondingTokens.forEach(el => el.classList.remove('active'));
        correspondingIds.forEach(el => el.classList.remove('active'));
      });
    }
  });

  document.querySelectorAll('.token-pill').forEach(pillEl => {
    const index = parseInt(pillEl.dataset.index);
    if (!isNaN(index)) {
      const correspondingWord = document.querySelector(`.text-input-word[data-index="${index}"]`);
      const correspondingId = document.querySelector(`.id-pill[data-index="${index}"]`);

      pillEl.addEventListener('mouseenter', () => {
        if (correspondingWord) correspondingWord.classList.add('active');
        pillEl.classList.add('active');
        if (correspondingId) correspondingId.classList.add('active');
      });
      pillEl.addEventListener('mouseleave', () => {
        if (correspondingWord) correspondingWord.classList.remove('active');
        pillEl.classList.remove('active');
        if (correspondingId) correspondingId.classList.remove('active');
      });
    }
  });

  document.querySelectorAll('.id-pill').forEach(pillEl => {
    const index = parseInt(pillEl.dataset.index);
    if (!isNaN(index)) {
      const correspondingWord = document.querySelector(`.text-input-word[data-index="${index}"]`);
      const correspondingToken = document.querySelector(`.token-pill[data-index="${index}"]`);

      pillEl.addEventListener('mouseenter', () => {
        if (correspondingWord) correspondingWord.classList.add('active');
        if (correspondingToken) correspondingToken.classList.add('active');
        pillEl.classList.add('active');
      });
      pillEl.addEventListener('mouseleave', () => {
        if (correspondingWord) correspondingWord.classList.remove('active');
        if (correspondingToken) correspondingToken.classList.remove('active');
        pillEl.classList.remove('active');
      });
    }
  });
}

async function load(){
  const outEl = document.getElementById('out');
  try {
    const url = ENDPOINT + (ENDPOINT.includes('?') ? '' : `?ts=${Date.now()}`);
    const res = await fetch(url, {
      method: 'GET',
      headers: { 'Accept': 'application/json, text/plain;q=0.9, */*;q=0.8' },
      cache: 'no-store',
      mode: 'cors',
      credentials: USE_CREDENTIALS ? 'include' : 'omit'
    });

    if (!res.ok) {
      outEl.innerHTML = `<div class="text-center text-red-400">HTTP ${res.status} ${res.statusText}</div>`;
      return;
    }

    let payload;
    const text = await res.text();
    try {
      payload = JSON.parse(text);
    } catch {
      const cleaned = text.replace(/^\uFEFF/, '').replace(/^\)\]\}',?\s*\n?/, '').trim();
      payload = JSON.parse(cleaned);
    }

    const arr = pickArray(payload);
    if (!arr) {
      outEl.innerHTML = `<div class="text-center text-red-400">Parsed OK but could not locate a data array.</div>`;
      return;
    }
    render(arr);

  } catch (e) {
    outEl.innerHTML = `<div class="text-center text-red-400">Failed to load.</div>`;
    console.error(e);
  }
}

load();
</script>
</body>
</html>

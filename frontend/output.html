<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LLM Output Head — Explorer</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- KaTeX -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" crossorigin="anonymous" />
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>

  <style>
    /* Stage color palette */
.stage-transformer {
  background: #e3f2fd; /* light blue */
  border-left: 6px solid #64b5f6;
}
.stage-norm {
  background: #fff9c4; /* light yellow */
  border-left: 6px solid #fbc02d;
}
.stage-logits {
  background: #f3e5f5; /* light lavender */
  border-left: 6px solid #ab47bc;
}

    body {
      background: radial-gradient(800px 400px at 0% 0%, rgba(31,111,235,0.05), transparent 70%),
                  radial-gradient(800px 400px at 100% 0%, rgba(31,111,235,0.05), transparent 70%),
                  #f9fafb;
      font-family: Inter, system-ui, sans-serif;
      color: #0f1221;
    }
    .paper {
      max-width: 1100px; margin: 2rem auto;
      background: white; border: 1px solid #e5e7eb;
      border-radius: 14px; box-shadow: 0 10px 30px rgba(0,0,0,.06);
    }
    .btn {border:1px solid #d9d9d9; background:#fff;}
    .btn:hover{background:#f5f5f5}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;}
  </style>
</head>
<body>
  <article class="paper">
    <header class="px-6 py-6">
      <h1 class="text-2xl font-semibold">Output Head Explorer</h1>
      <p class="text-sm text-neutral-600 mt-2">Inspect hidden states and logits of the LLM.</p>
    </header>

    <section class="px-6 pb-4 grid md:grid-cols-2 gap-4">
      <div class="text-sm">
        <div class="font-medium mb-1">Live shapes</div>
        <div class="flex flex-wrap gap-2">
          <span class="px-2 py-1 rounded text-xs bg-gray-100 border">B=<span id="dimB">—</span></span>
          <span class="px-2 py-1 rounded text-xs bg-gray-100 border">T=<span id="dimT">—</span></span>
          <span class="px-2 py-1 rounded text-xs bg-gray-100 border">D=<span id="dimD">—</span></span>
          <span class="px-2 py-1 rounded text-xs bg-gray-100 border">V=<span id="dimV">—</span></span>
        </div>
        <div class="mt-2 text-xs text-neutral-600">
          Batch: <span class="mono" id="batchSpan">—</span>, 
          Token: <span class="mono" id="tokenSpan">—</span>
        </div>
        <div id="status" class="mt-2 text-xs text-neutral-600">Ready.</div>
      </div>
      <div class="text-sm">
        <div class="font-medium mb-1">Formulas</div>
        <div id="formulaBox"></div>
      </div>
    </section>

    <!-- Panels -->
    <section id="panels" class="px-6 pb-8 grid md:grid-cols-2 gap-6"></section>
  </article>

  <script>
    const ENDPOINT = '/output';
    const ABS = (u) => (!u ? u : (/^https?:\/\//.test(u) || u.startsWith('/') ? u : '/' + u));

    const dimB=document.getElementById('dimB'), dimT=document.getElementById('dimT'),
          dimD=document.getElementById('dimD'), dimV=document.getElementById('dimV');
    const batchSpan=document.getElementById('batchSpan'), tokenSpan=document.getElementById('tokenSpan');
    const panelsEl=document.getElementById('panels');
    const statusEl=document.getElementById('status');

    function setStatus(m){ statusEl.textContent=m; }

   function renderFormulas(){
  const formulas = [
    // 1. Transformer output (pre-final norm)
    String.raw`x_L \in \mathbb{R}^{B \times T \times d_{model}}`,

    // 2. Final norm
    String.raw`\hat{y} = \mathrm{Norm}(x_L), \; \hat{y} \in \mathbb{R}^{B \times T \times d_{model}}`,

    // 3. Logits
    String.raw`\text{logits} = \hat{y} W^T + b, \; \in \mathbb{R}^{B \times T \times V}`
  ];

  document.getElementById('formulaBox').innerHTML =
    formulas.map(f => `$$${f}$$`).join('');

  renderMathInElement(document.body, {
    delimiters: [{ left: "$$", right: "$$", display: true }]
  });
}



    function asRows(arr,start,window=32){
      const rows=[]; const n=Math.min(window,arr.length-start);
      for(let i=0;i<n;i++){
        rows.push(`<tr><td class='px-2 py-1'>${start+i}</td><td class='px-2 py-1'>${arr[start+i]}</td></tr>`);
      }
      return rows.join('');
    }

    function makePanel(stage,dims){
      const {B,T,D,V} = dims;
  let shapeText = stage.name.includes("logits")
    ? `(${B}×${T}×${V})`
    : `(${B}×${T}×${D})`;

  // decide color class by stage
  let colorClass = "stage-transformer"; 
  if(stage.name.toLowerCase().includes("norm")) colorClass = "stage-norm";
  if(stage.name.toLowerCase().includes("logits")) colorClass = "stage-logits";

  const card=document.createElement('div');
  card.className=`rounded-lg border p-4 ${colorClass}`;
  card.innerHTML=`
    <h2 class="font-semibold mb-2">${stage.name} 
      <span class="text-xs text-neutral-600">${shapeText}</span>
    </h2>
    <p class="text-xs text-neutral-600 mb-2">
      Array values shown below are for the selected token only.
    </p>
    <button class="btn px-3 py-1 rounded text-sm expand">Expand</button>
    <div class="mt-3 hidden slider-wrap">
      <input type="range" class="slider w-full" min="0" max="0" value="0">
    </div>
    <div class="mt-3 hidden tensor-wrap h-56 overflow-auto border">
      <table class="w-full text-xs">
        <thead><tr class="text-neutral-500"><th class="text-left px-2 py-1">Index</th><th class="text-left px-2 py-1">Value</th></tr></thead>
        <tbody class="tbody font-mono"></tbody>
      </table>
    </div>`;

      const expandBtn=card.querySelector('.expand'),
            slider=card.querySelector('.slider'),
            sliderWrap=card.querySelector('.slider-wrap'),
            tbody=card.querySelector('.tbody'),
            tensorWrap=card.querySelector('.tensor-wrap');

      expandBtn.addEventListener('click',async()=>{
        expandBtn.disabled=true; setStatus(`Fetching ${stage.full_file}…`);
        try{
          const res=await fetch(ABS(stage.full_file),{cache:'no-store'});
          if(!res.ok) throw new Error('HTTP '+res.status);
          const data=await res.json();
          const vec=Array.isArray(data.vector)?data.vector:(Array.isArray(data.logits)?data.logits:[]);
          if(!vec.length) throw new Error('No tensor values');
          slider.max=Math.max(0,vec.length-1);
          slider.value=0;
          tbody.innerHTML=asRows(vec,0);
          sliderWrap.classList.remove('hidden');
          tensorWrap.classList.remove('hidden');
          slider.addEventListener('input',()=>{tbody.innerHTML=asRows(vec,+slider.value)});
        }catch(e){setStatus(e.message);}finally{expandBtn.disabled=false;}
      });
      return card;
    }

    async function load(){
      try{
        setStatus('Fetching manifest…');
        const res=await fetch(ENDPOINT,{cache:'no-store'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const payload=await res.json();
        const manifest=(payload&&payload.data)?payload.data:payload;

        dimB.textContent=manifest.dims.B; dimT.textContent=manifest.dims.T;
        dimD.textContent=manifest.dims.D; dimV.textContent=manifest.dims.V;
        batchSpan.textContent=manifest.selection.sample_index;
        tokenSpan.textContent=manifest.selection.token_index;

        panelsEl.innerHTML='';
        for(const st of manifest.stages){
          panelsEl.appendChild(makePanel(st,manifest.dims));
        }
        renderFormulas();
        setStatus('Manifest loaded.');
      }catch(err){setStatus('Error: '+err.message)}
    }

    document.addEventListener('DOMContentLoaded', load);
  </script>
</body>
</html>
